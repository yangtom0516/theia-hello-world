{"version":3,"file":"extension.js","mappings":"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","sources":["webpack://tunnel-forwarding/./src/deferredPromise.ts","webpack://tunnel-forwarding/./src/extension.ts","webpack://tunnel-forwarding/./src/split.ts","webpack://tunnel-forwarding/external commonjs \"vscode\"","webpack://tunnel-forwarding/external node-commonjs \"child_process\"","webpack://tunnel-forwarding/external node-commonjs \"path\"","webpack://tunnel-forwarding/external node-commonjs \"stream\"","webpack://tunnel-forwarding/webpack/bootstrap","webpack://tunnel-forwarding/webpack/startup"],"sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nexport type ValueCallback<T = unknown> = (value: T | Promise<T>) => void;\n\nconst enum DeferredOutcome {\n\tResolved,\n\tRejected\n}\n\n/**\n * Copied from src\\vs\\base\\common\\async.ts\n */\nexport class DeferredPromise<T> {\n\n\tprivate completeCallback!: ValueCallback<T>;\n\tprivate errorCallback!: (err: unknown) => void;\n\tprivate outcome?: { outcome: DeferredOutcome.Rejected; value: any } | { outcome: DeferredOutcome.Resolved; value: T };\n\n\tpublic get isRejected() {\n\t\treturn this.outcome?.outcome === DeferredOutcome.Rejected;\n\t}\n\n\tpublic get isResolved() {\n\t\treturn this.outcome?.outcome === DeferredOutcome.Resolved;\n\t}\n\n\tpublic get isSettled() {\n\t\treturn !!this.outcome;\n\t}\n\n\tpublic get value() {\n\t\treturn this.outcome?.outcome === DeferredOutcome.Resolved ? this.outcome?.value : undefined;\n\t}\n\n\tpublic readonly p: Promise<T>;\n\n\tconstructor() {\n\t\tthis.p = new Promise<T>((c, e) => {\n\t\t\tthis.completeCallback = c;\n\t\t\tthis.errorCallback = e;\n\t\t});\n\t}\n\n\tpublic complete(value: T) {\n\t\treturn new Promise<void>(resolve => {\n\t\t\tthis.completeCallback(value);\n\t\t\tthis.outcome = { outcome: DeferredOutcome.Resolved, value };\n\t\t\tresolve();\n\t\t});\n\t}\n\n\tpublic error(err: unknown) {\n\t\treturn new Promise<void>(resolve => {\n\t\t\tthis.errorCallback(err);\n\t\t\tthis.outcome = { outcome: DeferredOutcome.Rejected, value: err };\n\t\t\tresolve();\n\t\t});\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ChildProcessWithoutNullStreams, spawn } from 'child_process';\nimport * as path from 'path';\nimport * as vscode from 'vscode';\nimport { DeferredPromise } from './deferredPromise';\nimport { splitNewLines } from './split';\n\nexport const enum TunnelPrivacyId {\n\tPrivate = 'private',\n\tPublic = 'public',\n}\n\n/**\n * Timeout after the last port forwarding is disposed before we'll tear down\n * the CLI. This is primarily used since privacy changes to port will appear\n * as a dispose+re-create call, and we don't want to have to restart the CLI.\n */\nconst CLEANUP_TIMEOUT = 10_000;\n\nconst cliPath = process.env.VSCODE_FORWARDING_IS_DEV\n\t? path.join(__dirname, '../../../cli/target/debug/code')\n\t: path.join(\n\t\tvscode.env.appRoot,\n\t\tprocess.platform === 'darwin' ? 'bin' : '../../bin',\n\t\tvscode.env.appQuality === 'stable' ? 'code-tunnel' : 'code-tunnel-insiders',\n\t) + (process.platform === 'win32' ? '.exe' : '');\n\nclass Tunnel implements vscode.Tunnel {\n\tprivate readonly disposeEmitter = new vscode.EventEmitter<void>();\n\tpublic readonly onDidDispose = this.disposeEmitter.event;\n\tpublic localAddress!: string;\n\n\tconstructor(\n\t\tpublic readonly remoteAddress: { port: number; host: string },\n\t\tpublic readonly privacy: TunnelPrivacyId,\n\t\tpublic readonly protocol: 'http' | 'https',\n\t) { }\n\n\tpublic setPortFormat(formatString: string) {\n\t\tthis.localAddress = formatString.replace('{port}', String(this.remoteAddress.port));\n\t}\n\n\tdispose() {\n\t\tthis.disposeEmitter.fire();\n\t}\n}\n\nconst enum State {\n\tStarting,\n\tActive,\n\tInactive,\n\tError,\n}\n\ntype StateT =\n\t| { state: State.Inactive }\n\t| { state: State.Starting; process: ChildProcessWithoutNullStreams; cleanupTimeout?: NodeJS.Timeout }\n\t| { state: State.Active; portFormat: string; process: ChildProcessWithoutNullStreams; cleanupTimeout?: NodeJS.Timeout }\n\t| { state: State.Error; error: string };\n\nexport async function activate(context: vscode.ExtensionContext) {\n\tif (vscode.env.remoteAuthority) {\n\t\treturn; // forwarding is local-only at the moment\n\t}\n\n\tconst logger = new Logger(vscode.l10n.t('Port Forwarding'));\n\tconst provider = new TunnelProvider(logger, context);\n\n\tcontext.subscriptions.push(\n\t\tvscode.commands.registerCommand('tunnel-forwarding.showLog', () => logger.show()),\n\t\tvscode.commands.registerCommand('tunnel-forwarding.restart', () => provider.restart()),\n\n\t\tprovider.onDidStateChange(s => {\n\t\t\tvscode.commands.executeCommand('setContext', 'tunnelForwardingIsRunning', s.state !== State.Inactive);\n\t\t}),\n\n\t\tawait vscode.workspace.registerTunnelProvider(\n\t\t\tprovider,\n\t\t\t{\n\t\t\t\ttunnelFeatures: {\n\t\t\t\t\televation: false,\n\t\t\t\t\tprotocol: true,\n\t\t\t\t\tprivacyOptions: [\n\t\t\t\t\t\t{ themeIcon: 'globe', id: TunnelPrivacyId.Public, label: vscode.l10n.t('Public') },\n\t\t\t\t\t\t{ themeIcon: 'lock', id: TunnelPrivacyId.Private, label: vscode.l10n.t('Private') },\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t},\n\t\t),\n\t);\n}\n\nexport function deactivate() { }\n\nclass Logger {\n\tprivate outputChannel?: vscode.LogOutputChannel;\n\n\tconstructor(private readonly label: string) { }\n\n\tpublic show(): void {\n\t\treturn this.outputChannel?.show();\n\t}\n\n\tpublic clear() {\n\t\tthis.outputChannel?.clear();\n\t}\n\n\tpublic log(\n\t\tlogLevel: 'trace' | 'debug' | 'info' | 'warn' | 'error',\n\t\tmessage: string,\n\t\t...args: unknown[]\n\t) {\n\t\tif (!this.outputChannel) {\n\t\t\tthis.outputChannel = vscode.window.createOutputChannel(this.label, { log: true });\n\t\t\tvscode.commands.executeCommand('setContext', 'tunnelForwardingHasLog', true);\n\t\t}\n\t\tthis.outputChannel[logLevel](message, ...args);\n\t}\n}\n\nconst didWarnPublicKey = 'didWarnPublic';\n\nclass TunnelProvider implements vscode.TunnelProvider {\n\tprivate readonly tunnels = new Set<Tunnel>();\n\tprivate readonly stateChange = new vscode.EventEmitter<StateT>();\n\tprivate _state: StateT = { state: State.Inactive };\n\n\tprivate get state(): StateT {\n\t\treturn this._state;\n\t}\n\n\tprivate set state(state: StateT) {\n\t\tthis._state = state;\n\t\tthis.stateChange.fire(state);\n\t}\n\n\tpublic readonly onDidStateChange = this.stateChange.event;\n\n\tconstructor(private readonly logger: Logger, private readonly context: vscode.ExtensionContext) { }\n\n\t/** @inheritdoc */\n\tpublic async provideTunnel(tunnelOptions: vscode.TunnelOptions): Promise<vscode.Tunnel | undefined> {\n\t\tif (tunnelOptions.privacy === TunnelPrivacyId.Public) {\n\t\t\tif (!(await this.consentPublicPort(tunnelOptions.remoteAddress.port))) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tconst tunnel = new Tunnel(\n\t\t\ttunnelOptions.remoteAddress,\n\t\t\t(tunnelOptions.privacy as TunnelPrivacyId) || TunnelPrivacyId.Private,\n\t\t\ttunnelOptions.protocol === 'https' ? 'https' : 'http',\n\t\t);\n\n\t\tthis.tunnels.add(tunnel);\n\t\ttunnel.onDidDispose(() => {\n\t\t\tthis.tunnels.delete(tunnel);\n\t\t\tthis.updateActivePortsIfRunning();\n\t\t});\n\n\t\tswitch (this.state.state) {\n\t\t\tcase State.Error:\n\t\t\tcase State.Inactive:\n\t\t\t\tawait this.setupPortForwardingProcess();\n\t\t\t// fall through since state is now starting\n\t\t\tcase State.Starting:\n\t\t\t\tthis.updateActivePortsIfRunning();\n\t\t\t\treturn new Promise<Tunnel>((resolve, reject) => {\n\t\t\t\t\tconst l = this.stateChange.event(state => {\n\t\t\t\t\t\tif (state.state === State.Active) {\n\t\t\t\t\t\t\ttunnel.setPortFormat(state.portFormat);\n\t\t\t\t\t\t\tl.dispose();\n\t\t\t\t\t\t\tresolve(tunnel);\n\t\t\t\t\t\t} else if (state.state === State.Error) {\n\t\t\t\t\t\t\tl.dispose();\n\t\t\t\t\t\t\treject(new Error(state.error));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\tcase State.Active:\n\t\t\t\ttunnel.setPortFormat(this.state.portFormat);\n\t\t\t\tthis.updateActivePortsIfRunning();\n\t\t\t\treturn tunnel;\n\t\t}\n\t}\n\n\t/** Re/starts the port forwarding system. */\n\tpublic async restart() {\n\t\tthis.killRunningProcess();\n\t\tawait this.setupPortForwardingProcess(); // will show progress\n\t\tthis.updateActivePortsIfRunning();\n\t}\n\n\tprivate async consentPublicPort(portNumber: number) {\n\t\tconst didWarn = this.context.globalState.get(didWarnPublicKey, false);\n\t\tif (didWarn) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst continueOpt = vscode.l10n.t('Continue');\n\t\tconst dontShowAgain = vscode.l10n.t(\"Don't show again\");\n\t\tconst r = await vscode.window.showWarningMessage(\n\t\t\tvscode.l10n.t(\"You're about to create a publicly forwarded port. Anyone on the internet will be able to connect to the service listening on port {0}. You should only proceed if this service is secure and non-sensitive.\", portNumber),\n\t\t\t{ modal: true },\n\t\t\tcontinueOpt,\n\t\t\tdontShowAgain,\n\t\t);\n\t\tif (r === continueOpt) {\n\t\t\t// continue\n\t\t} else if (r === dontShowAgain) {\n\t\t\tawait this.context.globalState.update(didWarnPublicKey, true);\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tprivate isInStateWithProcess(process: ChildProcessWithoutNullStreams) {\n\t\treturn (\n\t\t\t(this.state.state === State.Starting || this.state.state === State.Active) &&\n\t\t\tthis.state.process === process\n\t\t);\n\t}\n\n\tprivate killRunningProcess() {\n\t\tif (this.state.state === State.Starting || this.state.state === State.Active) {\n\t\t\tthis.logger.log('info', '[forwarding] no more ports, stopping forwarding CLI');\n\t\t\tthis.state.process.kill();\n\t\t\tthis.state = { state: State.Inactive };\n\t\t}\n\t}\n\n\tprivate updateActivePortsIfRunning() {\n\t\tif (this.state.state !== State.Starting && this.state.state !== State.Active) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst ports = [...this.tunnels].map(t => ({ number: t.remoteAddress.port, privacy: t.privacy, protocol: t.protocol }));\n\t\tthis.state.process.stdin.write(`${JSON.stringify(ports)}\\n`);\n\n\t\tif (ports.length === 0 && !this.state.cleanupTimeout) {\n\t\t\tthis.state.cleanupTimeout = setTimeout(() => this.killRunningProcess(), CLEANUP_TIMEOUT);\n\t\t} else if (ports.length > 0 && this.state.cleanupTimeout) {\n\t\t\tclearTimeout(this.state.cleanupTimeout);\n\t\t\tthis.state.cleanupTimeout = undefined;\n\t\t}\n\t}\n\n\tprivate async setupPortForwardingProcess() {\n\t\tconst session = await vscode.authentication.getSession('github', ['user:email', 'read:org'], {\n\t\t\tcreateIfNone: true,\n\t\t});\n\n\t\tconst args = [\n\t\t\t'--verbose',\n\t\t\t'tunnel',\n\t\t\t'forward-internal',\n\t\t\t'--provider',\n\t\t\t'github',\n\t\t];\n\n\t\tthis.logger.log('info', '[forwarding] starting CLI');\n\t\tconst child = spawn(cliPath, args, { stdio: 'pipe', env: { ...process.env, NO_COLOR: '1', VSCODE_CLI_ACCESS_TOKEN: session.accessToken } });\n\t\tthis.state = { state: State.Starting, process: child };\n\n\t\tconst progressP = new DeferredPromise<void>();\n\t\tvscode.window.withProgress(\n\t\t\t{\n\t\t\t\tlocation: vscode.ProgressLocation.Notification,\n\t\t\t\ttitle: vscode.l10n.t({\n\t\t\t\t\tcomment: ['do not change link format [Show Log](command), only change the text \"Show Log\"'],\n\t\t\t\t\tmessage: 'Starting port forwarding system ([Show Log]({0}))',\n\t\t\t\t\targs: ['command:tunnel-forwarding.showLog']\n\t\t\t\t}),\n\t\t\t},\n\t\t\t() => progressP.p,\n\t\t);\n\n\t\tlet lastPortFormat: string | undefined;\n\t\tchild.on('exit', status => {\n\t\t\tconst msg = `[forwarding] exited with code ${status}`;\n\t\t\tthis.logger.log('info', msg);\n\t\t\tprogressP.complete(); // make sure to clear progress on unexpected exit\n\t\t\tif (this.isInStateWithProcess(child)) {\n\t\t\t\tthis.state = { state: State.Error, error: msg };\n\t\t\t}\n\t\t});\n\n\t\tchild.on('error', err => {\n\t\t\tthis.logger.log('error', `[forwarding] ${err}`);\n\t\t\tprogressP.complete(); // make sure to clear progress on unexpected exit\n\t\t\tif (this.isInStateWithProcess(child)) {\n\t\t\t\tthis.state = { state: State.Error, error: String(err) };\n\t\t\t}\n\t\t});\n\n\t\tchild.stdout\n\t\t\t.pipe(splitNewLines())\n\t\t\t.on('data', line => this.logger.log('info', `[forwarding] ${line}`))\n\t\t\t.resume();\n\n\t\tchild.stderr\n\t\t\t.pipe(splitNewLines())\n\t\t\t.on('data', line => {\n\t\t\t\ttry {\n\t\t\t\t\tconst l: { port_format: string } = JSON.parse(line);\n\t\t\t\t\tif (l.port_format && l.port_format !== lastPortFormat) {\n\t\t\t\t\t\tthis.state = {\n\t\t\t\t\t\t\tstate: State.Active,\n\t\t\t\t\t\t\tportFormat: l.port_format, process: child,\n\t\t\t\t\t\t\tcleanupTimeout: 'cleanupTimeout' in this.state ? this.state.cleanupTimeout : undefined,\n\t\t\t\t\t\t};\n\t\t\t\t\t\tprogressP.complete();\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\tthis.logger.log('error', `[forwarding] ${line}`);\n\t\t\t\t}\n\t\t\t})\n\t\t\t.resume();\n\n\t\tawait new Promise((resolve, reject) => {\n\t\t\tchild.on('spawn', resolve);\n\t\t\tchild.on('error', reject);\n\t\t});\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Transform } from 'stream';\n\nexport const splitNewLines = () => new StreamSplitter('\\n'.charCodeAt(0));\n\n/**\n * Copied and simplified from src\\vs\\base\\node\\nodeStreams.ts\n *\n * Exception: does not include the split character in the output.\n */\nexport class StreamSplitter extends Transform {\n\tprivate buffer: Buffer | undefined;\n\n\tconstructor(private readonly splitter: number) {\n\t\tsuper();\n\t}\n\n\toverride _transform(chunk: Buffer, _encoding: string, callback: (error?: Error | null, data?: any) => void): void {\n\t\tif (!this.buffer) {\n\t\t\tthis.buffer = chunk;\n\t\t} else {\n\t\t\tthis.buffer = Buffer.concat([this.buffer, chunk]);\n\t\t}\n\n\t\tlet offset = 0;\n\t\twhile (offset < this.buffer.length) {\n\t\t\tconst index = this.buffer.indexOf(this.splitter, offset);\n\t\t\tif (index === -1) {\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tthis.push(this.buffer.subarray(offset, index));\n\t\t\toffset = index + 1;\n\t\t}\n\n\t\tthis.buffer = offset === this.buffer.length ? undefined : this.buffer.subarray(offset);\n\t\tcallback();\n\t}\n\n\toverride _flush(callback: (error?: Error | null, data?: any) => void): void {\n\t\tif (this.buffer) {\n\t\t\tthis.push(this.buffer);\n\t\t}\n\n\t\tcallback();\n\t}\n}\n","module.exports = require(\"vscode\");","module.exports = require(\"child_process\");","module.exports = require(\"path\");","module.exports = require(\"stream\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\nvar __webpack_exports__ = __webpack_require__(256);\n"],"names":["isRejected","this","outcome","isResolved","isSettled","value","undefined","constructor","p","Promise","c","e","completeCallback","errorCallback","complete","resolve","error","err","async","context","vscode","env","remoteAuthority","logger","Logger","l10n","t","provider","TunnelProvider","subscriptions","push","commands","registerCommand","show","restart","onDidStateChange","s","executeCommand","state","workspace","registerTunnelProvider","tunnelFeatures","elevation","protocol","privacyOptions","themeIcon","id","label","cliPath","process","VSCODE_FORWARDING_IS_DEV","path","join","__dirname","appRoot","platform","appQuality","Tunnel","remoteAddress","privacy","disposeEmitter","EventEmitter","onDidDispose","event","setPortFormat","formatString","localAddress","replace","String","port","dispose","fire","outputChannel","clear","log","logLevel","message","args","window","createOutputChannel","didWarnPublicKey","_state","stateChange","tunnels","Set","provideTunnel","tunnelOptions","consentPublicPort","tunnel","add","delete","updateActivePortsIfRunning","setupPortForwardingProcess","reject","l","portFormat","Error","killRunningProcess","portNumber","globalState","get","continueOpt","dontShowAgain","r","showWarningMessage","modal","update","isInStateWithProcess","kill","ports","map","number","stdin","write","JSON","stringify","length","cleanupTimeout","clearTimeout","setTimeout","session","authentication","getSession","createIfNone","child","spawn","stdio","NO_COLOR","VSCODE_CLI_ACCESS_TOKEN","accessToken","progressP","DeferredPromise","withProgress","location","ProgressLocation","Notification","title","comment","on","status","msg","stdout","pipe","splitNewLines","line","resume","stderr","parse","port_format","lastPortFormat","StreamSplitter","charCodeAt","Transform","splitter","super","_transform","chunk","_encoding","callback","buffer","Buffer","concat","offset","index","indexOf","subarray","_flush","module","exports","require","__webpack_module_cache__","__webpack_exports__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","call"],"sourceRoot":""}